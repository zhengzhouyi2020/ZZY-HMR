<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš–å¿ƒç•™è¨€æ¿ | æ°¸ä¹…ä¿å­˜çš„ç¾å¥½ç¬é—´</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <!-- è‡ªå®šä¹‰é…ç½®Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // ä¸»è‰²è°ƒï¼šæ¸©æŸ”ç´«è“
                        secondary: '#EC4899', // è¾…åŠ©è‰²ï¼šæµªæ¼«ç²‰ç´«
                        neutral: {
                            50: '#F9FAFB',
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 8px 30px rgba(0, 0, 0, 0.12)',
                    }
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .bg-gradient {
                background: linear-gradient(135deg, #4F46E5 0%, #EC4899 100%);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
        }

        /* è‡ªå®šä¹‰åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        .message-card {
            animation: fadeIn 0.3s ease forwards;
        }
        .message-card:nth-child(odd) {
            animation-delay: 0.1s;
        }
        .message-card:nth-child(even) {
            animation-delay: 0.2s;
        }
    </style>
</head>
<body class="bg-neutral-50 min-h-screen font-sans text-neutral-800">
    <!-- é¡µé¢å¤´éƒ¨ - æ¸å˜èƒŒæ™¯+æ¯›ç»ç’ƒæ•ˆæœ -->
    <header class="bg-gradient text-white py-8 shadow-lg relative overflow-hidden">
        <!-- è£…é¥°å…ƒç´  -->
        <div class="absolute top-0 left-0 w-full h-full opacity-10">
            <div class="absolute top-10 left-10 w-40 h-40 rounded-full bg-white"></div>
            <div class="absolute bottom-10 right-10 w-60 h-60 rounded-full bg-white"></div>
        </div>
        
        <div class="container mx-auto px-4 relative z-10">
            <div class="flex flex-col items-center text-center">
                <i class="fa fa-heart text-4xl mb-4 text-white/90"></i>
                <h1 class="text-[clamp(1.8rem,5vw,2.8rem)] font-bold text-shadow mb-2">æš–å¿ƒç•™è¨€æ¿</h1>
                <p class="text-white/90 max-w-md">æ¯ä¸€æ¡ç•™è¨€ï¼Œéƒ½æ˜¯æ—¶å…‰çš„å°è®°ï¼Œæ°¸ä¹…ä¿å­˜åœ¨GitHub</p>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <main class="container mx-auto px-4 py-8 max-w-3xl">
        <!-- ç•™è¨€è¾“å…¥è¡¨å• - å¡ç‰‡å¼è®¾è®¡+æ‚¬æµ®é˜´å½± -->
        <section class="bg-white rounded-xl shadow-card p-6 mb-10 transform hover:shadow-card-hover transition-all-300">
            <h2 class="text-xl font-semibold mb-6 text-neutral-800 flex items-center gap-2">
                <i class="fa fa-pencil-square-o text-primary"></i> å†™ä¸‹ä½ çš„ç•™è¨€
            </h2>
            
            <form id="messageForm" class="space-y-5">
                <div>
                    <label for="author" class="block text-sm font-medium text-neutral-700 mb-2">ä½ çš„æ˜µç§°</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-neutral-500">
                            <i class="fa fa-user"></i>
                        </span>
                        <input type="text" id="author" name="author" required
                            class="w-full pl-10 pr-3 py-3 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all-300 bg-neutral-50"
                            placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼ˆå¦‚ï¼šå°å¹¸è¿ï¼‰">
                    </div>
                </div>
                
                <div>
                    <label for="content" class="block text-sm font-medium text-neutral-700 mb-2">ç•™è¨€å†…å®¹</label>
                    <div class="relative">
                        <span class="absolute top-3 left-3 text-neutral-500">
                            <i class="fa fa-comment"></i>
                        </span>
                        <textarea id="content" name="content" rows="5" required
                            class="w-full pl-10 pr-3 py-3 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all-300 bg-neutral-50 resize-none"
                            placeholder="åˆ†äº«ä½ çš„å¿ƒæƒ…ã€æ•…äº‹æˆ–æƒ³è¯´çš„è¯..."></textarea>
                        <div class="absolute right-3 bottom-3 text-xs text-neutral-500">
                            <span id="charCount">0</span>/500
                        </div>
                    </div>
                </div>
                
                <button type="submit" id="submitBtn"
                    class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all-300 flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                    <i class="fa fa-paper-plane"></i> æäº¤ç•™è¨€
                </button>
            </form>
            
            <p id="submitStatus" class="mt-4 text-sm hidden animate-fade-in"></p>
        </section>

        <!-- ç•™è¨€åˆ—è¡¨ -->
        <section>
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-neutral-800 flex items-center gap-2">
                    <i class="fa fa-comments text-primary"></i> æ‰€æœ‰ç•™è¨€
                </h2>
                <span id="messageCount" class="text-sm text-neutral-500">0 æ¡ç•™è¨€</span>
            </div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingMessages" class="text-center py-12">
                <div class="inline-block w-8 h-8 border-4 border-neutral-200 border-t-primary rounded-full animate-spin mb-4"></div>
                <p class="text-neutral-500">åŠ è½½ç•™è¨€ä¸­...</p>
            </div>
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="emptyMessage" class="text-center py-16 hidden">
                <div class="mb-4 text-neutral-300">
                    <i class="fa fa-inbox text-6xl"></i>
                </div>
                <p class="text-neutral-500 mb-2">æš‚æ— ç•™è¨€</p>
                <p class="text-sm text-neutral-400">å¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡æš–å¿ƒç•™è¨€å§ âœ¨</p>
            </div>
            
            <!-- ç•™è¨€åˆ—è¡¨å®¹å™¨ -->
            <div id="messageList" class="space-y-5 hidden"></div>
        </section>
    </main>

    <!-- é¡µè„š -->
    <footer class="bg-neutral-800 text-white py-6 mt-auto">
        <div class="container mx-auto px-4 text-center text-sm text-neutral-400">
            <p>ğŸ’– ç•™è¨€æ°¸ä¹…ä¿å­˜äº GitHub | æš–å¿ƒé™ªä¼´ï¼Œä¸è´Ÿæ—¶å…‰ ğŸ’–</p>
            <p class="mt-2">Â© 2025 æš–å¿ƒç•™è¨€æ¿ | æ‰€æœ‰ç•™è¨€å‡ä¸ºç”¨æˆ·è‡ªæ„¿å‘å¸ƒ</p>
        </div>
    </footer>

    <script>
        // ========== æ ¸å¿ƒé…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„ä¿¡æ¯ï¼‰ ==========
        const CONFIG = {
            // GitHubä»“åº“ä¿¡æ¯ï¼ˆå¿…å¡«ï¼‰
            owner: "zhengzhouyi2020", // å¦‚ï¼šoctocat
            repo: "ZZY-HMR", // å¦‚ï¼šmessage-board
            path: "comments", // å­˜å‚¨ç•™è¨€çš„æ–‡ä»¶è·¯å¾„
            // GitHub Personal Access Tokenï¼ˆå¿…å¡«ï¼Œéœ€æœ‰repoæƒé™ï¼‰
            token: "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",
            // å¯é€‰ï¼šAPIåŸºç¡€è·¯å¾„
            apiBaseUrl: "https://api.github.com"
        };

        // ========== å·¥å…·å‡½æ•° ==========
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString("zh-CN", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
            });
        }

        // æ˜¾ç¤ºæäº¤çŠ¶æ€
        function showSubmitStatus(text, isError = false) {
            const statusEl = document.getElementById("submitStatus");
            statusEl.textContent = text;
            statusEl.className = `mt-4 text-sm animate-fade-in ${isError ? "text-red-500" : "text-green-500"}`;
            statusEl.classList.remove("hidden");
            
            // 3ç§’åéšè—
            setTimeout(() => {
                statusEl.classList.add("hidden");
            }, 3000);
        }

        // å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const content = document.getElementById("content").value;
            const charCount = document.getElementById("charCount");
            charCount.textContent = content.length;
            
            // è¶…è¿‡500å­—ç¬¦æ ‡çº¢
            if (content.length > 500) {
                charCount.classList.add("text-red-500");
                document.getElementById("content").value = content.substring(0, 500);
                charCount.textContent = 500;
            } else {
                charCount.classList.remove("text-red-500");
            }
        }

        // ========== GitHub API äº¤äº’ ==========
        // 1. è·å–æ–‡ä»¶çš„SHAï¼ˆç”¨äºæ›´æ–°æ–‡ä»¶ï¼‰
        async function getFileSha() {
            try {
                const response = await fetch(
                    `${CONFIG.apiBaseUrl}/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`,
                    {
                        headers: {
                            Authorization: `token ${CONFIG.token}`,
                            Accept: "application/vnd.github.v3+json"
                        }
                    }
                );
                if (response.status === 404) return null; // æ–‡ä»¶ä¸å­˜åœ¨
                if (!response.ok) throw new Error("è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥");
                const data = await response.json();
                return data.sha;
            } catch (error) {
                console.error("è·å–SHAå¤±è´¥ï¼š", error);
                return null;
            }
        }

        // 2. è·å–æ‰€æœ‰ç•™è¨€
        async function fetchMessages() {
            const loadingEl = document.getElementById("loadingMessages");
            const listEl = document.getElementById("messageList");
            const emptyEl = document.getElementById("emptyMessage");
            const countEl = document.getElementById("messageCount");

            try {
                const response = await fetch(
                    `${CONFIG.apiBaseUrl}/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`,
                    {
                        headers: {
                            Accept: "application/vnd.github.v3+json"
                        }
                    }
                );

                // å¤„ç†æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ
                if (response.status === 404) {
                    loadingEl.classList.add("hidden");
                    emptyEl.classList.remove("hidden");
                    countEl.textContent = "0 æ¡ç•™è¨€";
                    return [];
                }

                if (!response.ok) throw new Error("åŠ è½½ç•™è¨€å¤±è´¥");

                const data = await response.json();
                // è§£ç base64å†…å®¹
                const content = atob(data.content.replace(/\n/g, ""));
                const messages = JSON.parse(content || "[]");

                // æ›´æ–°è®¡æ•°
                countEl.textContent = `${messages.length} æ¡ç•™è¨€`;

                // æ¸²æŸ“åˆ—è¡¨
                loadingEl.classList.add("hidden");
                if (messages.length === 0) {
                    emptyEl.classList.remove("hidden");
                } else {
                    listEl.classList.remove("hidden");
                    // æŒ‰æ—¶é—´å€’åºæ’åˆ—
                    messages.sort((a, b) => b.timestamp - a.timestamp);
                    // ç”ŸæˆHTML
                    listEl.innerHTML = messages.map((msg, index) => `
                        <div class="message-card bg-white rounded-xl shadow-card p-5 transform hover:shadow-card-hover transition-all-300">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-medium">
                                        ${msg.author.charAt(0)}
                                    </div>
                                    <span class="font-medium text-neutral-800">${msg.author}</span>
                                </div>
                                <span class="text-xs text-neutral-500">${formatTime(msg.timestamp)}</span>
                            </div>
                            <p class="text-neutral-700 leading-relaxed whitespace-pre-line">${msg.content}</p>
                            <div class="mt-4 pt-3 border-t border-neutral-100 flex justify-end">
                                <span class="text-xs text-neutral-400">#${messages.length - index}</span>
                            </div>
                        </div>
                    `).join("");
                }

                return messages;
            } catch (error) {
                console.error("åŠ è½½ç•™è¨€å¤±è´¥ï¼š", error);
                loadingEl.innerHTML = `
                    <div class="text-red-500 mb-2"><i class="fa fa-exclamation-circle"></i></div>
                    <p class="text-red-500">åŠ è½½å¤±è´¥ï¼š${error.message}</p>
                    <button onclick="fetchMessages()" class="mt-4 text-primary text-sm underline">é‡è¯•</button>
                `;
                return [];
            }
        }

        // 3. æäº¤æ–°ç•™è¨€
        async function submitMessage(author, content) {
            const submitBtn = document.getElementById("submitBtn");
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div> æäº¤ä¸­...';

            try {
                // 1. è·å–ç°æœ‰ç•™è¨€
                const existingMessages = await fetchMessages();
                // 2. æ„é€ æ–°ç•™è¨€
                const newMessage = {
                    author,
                    content,
                    timestamp: Date.now()
                };
                const allMessages = [...existingMessages, newMessage];
                // 3. è·å–æ–‡ä»¶SHAï¼ˆæ›´æ–°éœ€è¦ï¼‰
                const sha = await getFileSha();
                // 4. å‡†å¤‡æäº¤æ•°æ®
                const payload = {
                    message: `æ–°å¢ç•™è¨€ï¼š${author} - ${new Date().toLocaleString()}`,
                    content: btoa(JSON.stringify(allMessages, null, 2)),
                    branch: "main"
                };
                // å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œéœ€è¦ä¼ å…¥sha
                if (sha) payload.sha = sha;

                // 5. è°ƒç”¨GitHub APIæäº¤
                const response = await fetch(
                    `${CONFIG.apiBaseUrl}/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`,
                    {
                        method: "PUT",
                        headers: {
                            Authorization: `token ${CONFIG.token}`,
                            Accept: "application/vnd.github.v3+json",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.message || "æäº¤å¤±è´¥");
                }

                showSubmitStatus("ç•™è¨€æäº¤æˆåŠŸï¼âœ¨", false);
                // é‡æ–°åŠ è½½ç•™è¨€åˆ—è¡¨
                setTimeout(() => fetchMessages(), 800);
                // é‡ç½®è¡¨å•
                document.getElementById("messageForm").reset();
                updateCharCount();

            } catch (error) {
                console.error("æäº¤å¤±è´¥ï¼š", error);
                showSubmitStatus(`æäº¤å¤±è´¥ï¼š${error.message}`, true);
            } finally {
                // æ¢å¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-paper-plane"></i> æäº¤ç•™è¨€';
            }
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        document.addEventListener("DOMContentLoaded", () => {
            // åŠ è½½ç°æœ‰ç•™è¨€
            fetchMessages();

            // å­—ç¬¦è®¡æ•°ç›‘å¬
            document.getElementById("content").addEventListener("input", updateCharCount);
            
            // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
            updateCharCount();

            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById("messageForm").addEventListener("submit", (e) => {
                e.preventDefault();
                const author = document.getElementById("author").value.trim();
                const content = document.getElementById("content").value.trim();

                if (!author) {
                    showSubmitStatus("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼", true);
                    return;
                }
                
                if (!content) {
                    showSubmitStatus("è¯·è¾“å…¥ç•™è¨€å†…å®¹ï¼", true);
                    return;
                }
                
                if (content.length > 500) {
                    showSubmitStatus("ç•™è¨€å†…å®¹ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦ï¼", true);
                    return;
                }

                submitMessage(author, content);
            });

            // å¹³æ»‘æ»šåŠ¨
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });
        });
    </script>
</body>
</html>